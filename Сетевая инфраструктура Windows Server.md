# Сетевая инфраструктура Windows Server

## Сценарий

Contoso, Ltd. — это компания, предоставляющая финансовые услуги в  Сиэтле, офисы которой расположены по всему миру. Большая часть среды  вычислений запущена локально на Windows Server. Сюда входят  виртуализированные рабочие нагрузки на узлах Windows Server 2016.

Сотрудники ИТ-отдела компании Contoso осуществляют перенос локальных  серверов Contoso на Windows Server 2019. Как администратор  инфраструктуры Windows Server вы отвечаете за управление сетевой  инфраструктурой для Windows Server и ее обслуживание, что помогает  компании Contoso достичь своих бизнес-целей. В рамках этой роли  необходимо развернуть и обслуживать DHCP-серверы, чтобы автоматизировать выделение конфигураций IP-адресов в организации.

После прохождения этого модуля вы узнаете, как установить и настроить роль DHCP-сервера на компьютерах под управлением Windows Server 2019 и  управлять ею. Вы также узнаете, как развертывать и настраивать параметры высокой доступности DHCP.

## Цели обучения

По завершении этого модуля вы получите следующие навыки:

- Описание роли DHCP-сервера.
- Установка и настройка роли DHCP-сервера.
- Настройка параметров DHCP.
- Создание и настройка области DHCP.
- Описание параметров высокого уровня доступности для DHCP.
- Описание процедуры отработки отказа DHCP и объяснение принципов ее настройки.

## Предварительные требования

Для получения максимальной пользы от данного модуля вы должны иметь знания и опыт в следующих областях:

- Концепции и технологии доменных служб Active Directory.
- Windows Server.
- Базовые сетевые технологии.
- Клиентские операционные системы Windows, такие как Windows 10.







# Использование DHCP для упрощения настройки IP-адресов

DHCP автоматически настраивает сетевые устройства с использованием сведений о настройке IP-адреса. Это поможет ИТ-специалистам в компании  Contoso упростить и централизовать размещение конфигураций IP-адресов.  Если компания Contoso не использует DHCP, при каждом добавлении клиента в сеть потребуется настроить сетевой интерфейс с данными о сети, к  которой выполняется подключение.

 Совет

Сведения, которые необходимо настроить, включают IP-адрес, маску  подсети для сети, параметры DNS клиента для разрешения имен и шлюз по  умолчанию для доступа к другим сетям.

## Преимущества DHCP

Основное преимущество использования DHCP заключается в сокращении  объема обслуживания, необходимого для настройки сведений об IP-адресах  на сетевых устройствах. Многие организации управляют тысячами  компьютерных устройств, включая принтеры, сканеры, смартфоны, настольные компьютеры и ноутбуки. По этой причине управлять вручную конфигурациями IP-адресов сети для организаций такого размера непрактично.

Поскольку DHCP является автоматическим процессом, он более точен, чем настройка сведений об IP-адресах вручную. Это особенно важно для  пользователей, которые не знают и не понимают процесс настройки.

DHCP упрощает обновление сведений о конфигурации IP-адресов. Как  администратор, при изменении сетевой службы (например, при указании  нового DNS-сервера) вы выполняете только одно обновление на  DHCP-серверах, и эти изменения получают все DHCP-клиенты. Например,  мобильный пользователь с переносным компьютером, на котором используется DHCP, автоматически получает новые сведения о конфигурации IP-адресов  при подключении к новой сети.

 Примечание

По умолчанию все операционные системы Windows автоматически получают IP-адреса после первой установки операционной системы (ОС).

## Как работает DHCP

Служба DHCP-клиента выполняется на всех компьютерах Windows, для  которых свойства TCP/IP настроены для автоматического получения  IP-адреса. DHCP-клиент взаимодействует с DHCP-сервером для получения  сведений о конфигурации IP-адресов. Клиенты могут использовать  назначенный DHCP-адрес в течение определенного периода *аренды*.  DHCP-сервер настроен с использованием пула адресов и параметров  конфигурации. Эта информация определяет, какие данные о конфигурации  IP-адреса будут переданы клиентам. На следующем рисунке представлен процесс обмена данными, состоящий из  четырех этапов.

![Схема, на которой показан процесс обмена данными между DHCP-сервером и DHCP-клиентом. Он состоит из DHCPDISCOVER, DHCPOFFER, DHCPREQUEST и DHCPACK.](https://docs.microsoft.com/ru-ru/learn/wwl-windows-server/deploy-manage-dynamic-host-configuration-protocol/media/m11-dynamic-host-configuration-protocol-server-communication.png)

Для обмена данными при создании аренды DHCP используются  IP-трансляции. Поскольку IP-трансляции не маршрутизируются, необходимо  настроить DHCP-сервер в каждой подсети или настроить ретранслятор DHCP.  Многие маршрутизаторы предоставляют функции ретранслятора DHCP.

Четыре этапа создания аренды:

1. DHCP-клиент выполняет широковещательную рассылку пакета  DHCPDISCOVER. Единственными компьютерами, которые отправляют отклик,  являются компьютеры, имеющие роль DHCP-сервера, или компьютеры и  маршрутизаторы, на которых выполняется агент ретранслятора DHCP. В  последнем случае агент ретранслятора DHCP переадресует сообщение на  DHCP-сервер, настроенный для ретрансляции запросов.
2. DHCP-сервер отвечает пакетом DHCPOFFER, который содержит  потенциальный адрес клиента. Если несколько DHCP-серверов получат пакет  DHCPDISCOVER, отклик может прийти от нескольких DHCP-серверов.
3. Клиент получает пакет DHCPOFFER. Если клиент получает несколько  пакетов DHCPOFFER, он выбирает первый отклик. Затем клиент отправляет  пакет DHCPREQUEST, который содержит идентификатор сервера. Таким образом DHCP-серверы, которые принимают широковещательную рассылку, получают  информацию о том, какой сервер DHCPOFFER клиент решил принять.
4. DHCP-серверы получают пакет DHCPREQUEST. Серверы, которые клиент не  принял, используют это сообщение как уведомление о том, что клиент  отклонил предложение этого сервера. Выбранный сервер хранит сведения об  IP-адресе и клиенте в базе данных DHCP и отправляет в ответ сообщение  DHCPACK. Если DHCP-сервер не может предоставить адрес, предложенный в  начальном сообщении DHCPOFFER, DHCP-сервер отправляет сообщение DHCPNAK.

## Продление аренды DHCP

Когда пройдет 50 % времени аренды DHCP, клиент автоматически  попытается продлить аренду. Процесс выполняется в фоновом режиме.  Компьютер может использовать тот же IP-адрес, назначенный DHCP-серверу, в течение продолжительного времени. Это связано с тем, что компьютер  продлевает аренду несколько раз.

Чтобы продлить аренду IP-адреса, клиент отправляет одноадресное  сообщение DHCPREQUEST. Сервер, изначально арендовавший IP-адрес,  отправляет клиенту в ответ сообщение DHCPACK. Это сообщение содержит все новые параметры, измененные с момента создания исходной аренды.  Обратите внимание, что эти пакеты не включаются в широковещательную  рассылку, так как на этом этапе у клиента есть IP-адрес, который можно  использовать для одноадресной рассылки.

 Примечание

При обновлении параметров конфигурации DHCP клиенты могут не получить обновленные параметры до тех пор, пока не истечет 50 % времени аренды.  Например, если настроить срок аренды, равный шести дням, клиенты могут  три дня не получить обновленные параметры.

Если DHCP-клиент не может связаться с DHCP-сервером, клиент ждет,  пока не истечет 87,5 % времени аренды. На этом этапе клиент отправляет  широковещательное сообщение (не одноадресное) DHCPREQUEST, чтобы  получить продление аренды, а запрос передается на все DHCP-серверы, а не только на тот сервер, который предоставил исходную аренду. Однако этот  широковещательный запрос предназначен для продления, а не для получения  новой аренды.

Так как клиентские компьютеры можно перемещать, когда они отключены  (например, портативный компьютер, подключенный к новой подсети),  клиентские компьютеры также пытаются выполнить продление в процессе  запуска или при обнаружении компьютером изменения в сети. Если продление прошло успешно, период аренды сбрасывается.

## DHCP версии 6

DHCP версии 6 (DHCPv6) поддерживает конфигурации с отслеживанием  состояния и без отслеживания состояния для настройки клиентов в среде  IPv6. Конфигурация с отслеживанием состояния используется, когда  DHCPv6-сервер назначает клиенту адрес IPv6, а также дополнительные  данные DHCP. Конфигурация без отслеживания состояния используется, когда маршрутизатор назначает IPv6-адрес автоматически, и сервер DHCPv6  назначает только другие параметры конфигурации IPv6.



# Установка и настройка роли DHCP

Компания Contoso может установить роль DHCP-сервера только в  операционных системах Windows Server. Можно установить DHCP-сервер на  контроллере домена и разместить DHCP-сервер на любом сервере под  управлением Windows Server. Например, файл филиала и сервер печати также могут функционировать как локальный DHCP-сервер. Кроме того:

- Специалисты по установке должны иметь права локального администратора, чтобы выполнить установку.
- Сервер должен иметь статический IP-адрес.

## Установка роли DHCP-сервера

Роль **DHCP-сервера** можно установить с помощью **ролей и компонентов** в центре администрирования Windows или **мастера добавления ролей и компонентов** в консоли **Диспетчер сервера**.

![Снимок экрана для раздела &quot;Мастер добавления ролей и компонентов&quot; в диспетчере сервера. На странице &quot;Выбор ролей сервера&quot; администратор выбрал DHCP-сервер.](https://docs.microsoft.com/ru-ru/learn/wwl-windows-server/deploy-manage-dynamic-host-configuration-protocol/media/m11-dynamic-host-configuration-protocol-add.png)

Можно также использовать следующую команду Windows PowerShell:

PowerShell

```powershell
Add-WindowsFeature DHCP -IncludeManagementTools
```

 Примечание

Параметр `-IncludeManagementTools` не обязателен.

## Инструменты управления DHCP

При использовании **Диспетчера сервера** для установки роли DHCP-сервера **Диспетчер сервера** также устанавливает средства управления DHCP, командлеты модуля Windows DHCP PowerShell и, если сервер включает в себя функции рабочего стола,  консоль управления DHCP. Вы можете установить консоль **DHCP** или командлеты Windows PowerShell из средства удаленного  администрирования сервера (RSAT) на сервере Windows или в клиенте  Windows для удаленного администрирования.

![Снимок экрана для консоли DHCP. Администратор добавил один сервер sea-dc1.](https://docs.microsoft.com/ru-ru/learn/wwl-windows-server/deploy-manage-dynamic-host-configuration-protocol/media/m11-dynamic-host-configuration-protocol-1.png)

Для управления DHCP-сервером с помощью центра администрирования  Windows необходимо установить командлеты управления DHCP на  DHCP-сервере. Если эти командлеты не установлены, центр  администрирования Windows отобразит сообщение "Средства PowerShell DHCP  (RSAT) не установлены", а также кнопку "Установить" для удаленной  установки.

## Группы управления DHCP

Для делегирования функций управления DHCP каждый сервер DHCP включает локальную группу **Администраторы DHCP** и локальную группу **Пользователи DHCP**. Группа **Администраторы DHCP** управляет локальным DHCP-сервером, а группа **Пользователи DHCP** проверяет конфигурацию и сведения о состоянии на локальном DHCP-сервере.

При использовании **Диспетчера сервера** для установки  роли DHCP-сервера мастер настройки конфигурации создает обе группы после установки. Если для установки роли DHCP используется центр  администрирования Windows или Windows PowerShell, необходимо вручную  запустить создание групп.

Чтобы создать группы управления DHCP с помощью Windows PowerShell, выполните следующую команду:

PowerShell

```powershell
Add-DhcpServerSecurityGroup -Computer DhcpServerName
```

## Авторизация DHCP-AD DS

Обмен данными по протоколу DHCP обычно выполняется перед проверкой  подлинности пользователя или компьютера. Так как протокол DHCP создан на основе широковещательных IP-адресов, неизвестный DHCP-сервер может  предоставлять клиентам недопустимые сведения. Этого можно избежать,  авторизовав сервер. Можно использовать процесс, известный как  авторизация DHCP, чтобы зарегистрировать DHCP-сервер в домене Active  Directory, прежде чем он сможет поддерживать DHCP-клиенты. Авторизация  DHCP-сервера является одной из задач, которые необходимо выполнить после установки DHCP-сервера.

### Требования служб AD DS

Необходимо авторизовать роль DHCP-сервера Windows Server в AD DS,  прежде чем он сможет начать аренду IP-адресов. Можно использовать один  DHCP-сервер, указав IP-адреса для подсетей, содержащих несколько доменов AD DS. Поэтому для авторизации DHCP-сервера необходимо использовать  учетную запись администратора корпоративной сети. В среде с одним  доменом членства в группе "Администраторы домена" достаточно для  авторизации DHCP-сервера.

DHCP-сервер можно авторизовать с помощью консоли управления DHCP или  Windows PowerShell. Чтобы авторизовать DHCP-сервер с помощью Windows  PowerShell, выполните следующую команду:

PowerShell

```powershell
Add-DHCPServerinDC <hostname or IP address of DHCP server>
```

### Рекомендации по работе с автономным DHCP-сервером

Автономный DHCP-сервер — это компьютер под управлением Windows  Server, не являющийся членом AD DS, на котором установлена и настроена  роль DHCP-сервера. Если отдельный DHCP-сервер обнаруживает в домене  авторизованный DHCP-сервер, он не арендует IP-адреса и автоматически  завершает работу.

### Неавторизованные DHCP-серверы

Многие сетевые устройства содержат встроенное программное обеспечение DHCP-сервера, которое позволяет использовать их как DHCP-серверы.  DHCP-серверы на этих устройствах обычно не распознают авторизацию в AD  DS. Таким образом, эти DHCP-серверы будут арендовать IP-адреса при  подключении к сети с использованием программного обеспечения  DHCP-сервера. Чтобы найти такие неавторизованные DHCP-серверы,  необходимо провести расследование. При обнаружении неавторизованных  DHCP-серверов следует отключить на них службу DHCP. IP-адрес  неавторизованного DHCP-сервера можно найти, выполнив команду `ipconfig /all` на клиентском компьютере DHCP, который получил неверные сведения об IP-адресе.

## Демонстрация

В следующем видео показано, как развернуть роль DHCP-сервера с  помощью центра администрирования Windows. Основные этапы процесса  следующие.

1. В Microsoft Edge перейдите на веб-сайт центра администрирования Windows.
2. Подключитесь к компьютеру Windows Server.
3. В области **Инструменты** выберите **Роли и компоненты**
4. Выберите **DHCP-сервер**.
5. Завершите установку роли, а затем авторизуйте сервер в AD DS.

<iframe src="https://www.microsoft.com/ru-ru/videoplayer/embed/RWxT9j?postJsllMsg=true&amp;autoCaptions=ru-ru" allowfullscreen="true" data-linktype="external" frameborder="0"></iframe>



Сведения, которые необходимо настроить, включают IP-адрес, маску  подсети для сети, параметры DNS клиента для разрешения имен и шлюз по  умолчанию для доступа к другим сетям.

## Преимущества DHCP

Основное преимущество использования DHCP заключается в сокращении  объема обслуживания, необходимого для настройки сведений об IP-адресах  на сетевых устройствах. Многие организации управляют тысячами  компьютерных устройств, включая принтеры, сканеры, смартфоны, настольные компьютеры и ноутбуки. По этой причине управлять вручную конфигурациями IP-адресов сети для организаций такого размера непрактично.

Поскольку DHCP является автоматическим процессом, он более точен, чем настройка сведений об IP-адресах вручную. Это особенно важно для  пользователей, которые не знают и не понимают процесс настройки.

DHCP упрощает обновление сведений о конфигурации IP-адресов. Как  администратор, при изменении сетевой службы (например, при указании  нового DNS-сервера) вы выполняете только одно обновление на  DHCP-серверах, и эти изменения получают все DHCP-клиенты. Например,  мобильный пользователь с переносным компьютером, на котором используется DHCP, автоматически получает новые сведения о конфигурации IP-адресов  при подключении к новой сети.

 Примечание

По умолчанию все операционные системы Windows автоматически получают IP-адреса после первой установки операционной системы (ОС).

## Как работает DHCP

Служба DHCP-клиента выполняется на всех компьютерах Windows, для  которых свойства TCP/IP настроены для автоматического получения  IP-адреса. DHCP-клиент взаимодействует с DHCP-сервером для получения  сведений о конфигурации IP-адресов. Клиенты могут использовать  назначенный DHCP-адрес в течение определенного периода *аренды*.  DHCP-сервер настроен с использованием пула адресов и параметров  конфигурации. Эта информация определяет, какие данные о конфигурации  IP-адреса будут переданы клиентам. На следующем рисунке представлен процесс обмена данными, состоящий из  четырех этапов.

![Схема, на которой показан процесс обмена данными между DHCP-сервером и DHCP-клиентом. Он состоит из DHCPDISCOVER, DHCPOFFER, DHCPREQUEST и DHCPACK.](https://docs.microsoft.com/ru-ru/learn/wwl-windows-server/deploy-manage-dynamic-host-configuration-protocol/media/m11-dynamic-host-configuration-protocol-server-communication.png)

Для обмена данными при создании аренды DHCP используются  IP-трансляции. Поскольку IP-трансляции не маршрутизируются, необходимо  настроить DHCP-сервер в каждой подсети или настроить ретранслятор DHCP.  Многие маршрутизаторы предоставляют функции ретранслятора DHCP.

Четыре этапа создания аренды:

1. DHCP-клиент выполняет широковещательную рассылку пакета  DHCPDISCOVER. Единственными компьютерами, которые отправляют отклик,  являются компьютеры, имеющие роль DHCP-сервера, или компьютеры и  маршрутизаторы, на которых выполняется агент ретранслятора DHCP. В  последнем случае агент ретранслятора DHCP переадресует сообщение на  DHCP-сервер, настроенный для ретрансляции запросов.
2. DHCP-сервер отвечает пакетом DHCPOFFER, который содержит  потенциальный адрес клиента. Если несколько DHCP-серверов получат пакет  DHCPDISCOVER, отклик может прийти от нескольких DHCP-серверов.
3. Клиент получает пакет DHCPOFFER. Если клиент получает несколько  пакетов DHCPOFFER, он выбирает первый отклик. Затем клиент отправляет  пакет DHCPREQUEST, который содержит идентификатор сервера. Таким образом DHCP-серверы, которые принимают широковещательную рассылку, получают  информацию о том, какой сервер DHCPOFFER клиент решил принять.
4. DHCP-серверы получают пакет DHCPREQUEST. Серверы, которые клиент не  принял, используют это сообщение как уведомление о том, что клиент  отклонил предложение этого сервера. Выбранный сервер хранит сведения об  IP-адресе и клиенте в базе данных DHCP и отправляет в ответ сообщение  DHCPACK. Если DHCP-сервер не может предоставить адрес, предложенный в  начальном сообщении DHCPOFFER, DHCP-сервер отправляет сообщение DHCPNAK.

## Продление аренды DHCP

Когда пройдет 50 % времени аренды DHCP, клиент автоматически  попытается продлить аренду. Процесс выполняется в фоновом режиме.  Компьютер может использовать тот же IP-адрес, назначенный DHCP-серверу, в течение продолжительного времени. Это связано с тем, что компьютер  продлевает аренду несколько раз.

Чтобы продлить аренду IP-адреса, клиент отправляет одноадресное  сообщение DHCPREQUEST. Сервер, изначально арендовавший IP-адрес,  отправляет клиенту в ответ сообщение DHCPACK. Это сообщение содержит все новые параметры, измененные с момента создания исходной аренды.  Обратите внимание, что эти пакеты не включаются в широковещательную  рассылку, так как на этом этапе у клиента есть IP-адрес, который можно  использовать для одноадресной рассылки.

 Примечание

При обновлении параметров конфигурации DHCP клиенты могут не получить обновленные параметры до тех пор, пока не истечет 50 % времени аренды.  Например, если настроить срок аренды, равный шести дням, клиенты могут  три дня не получить обновленные параметры.

Если DHCP-клиент не может связаться с DHCP-сервером, клиент ждет,  пока не истечет 87,5 % времени аренды. На этом этапе клиент отправляет  широковещательное сообщение (не одноадресное) DHCPREQUEST, чтобы  получить продление аренды, а запрос передается на все DHCP-серверы, а не только на тот сервер, который предоставил исходную аренду. Однако этот  широковещательный запрос предназначен для продления, а не для получения  новой аренды.

Так как клиентские компьютеры можно перемещать, когда они отключены  (например, портативный компьютер, подключенный к новой подсети),  клиентские компьютеры также пытаются выполнить продление в процессе  запуска или при обнаружении компьютером изменения в сети. Если продление прошло успешно, период аренды сбрасывается.

## DHCP версии 6

DHCP версии 6 (DHCPv6) поддерживает конфигурации с отслеживанием  состояния и без отслеживания состояния для настройки клиентов в среде  IPv6. Конфигурация с отслеживанием состояния используется, когда  DHCPv6-сервер назначает клиенту адрес IPv6, а также дополнительные  данные DHCP. Конфигурация без отслеживания состояния используется, когда маршрутизатор назначает IPv6-адрес автоматически, и сервер DHCPv6  назначает только другие параметры конфигурации IPv6.
