
# Сетевая инфраструктура Windows Server

## Сценарий

Contoso, Ltd. — это компания, предоставляющая финансовые услуги в  Сиэтле, офисы которой расположены по всему миру. Большая часть среды  вычислений запущена локально на Windows Server. Сюда входят  виртуализированные рабочие нагрузки на узлах Windows Server 2016.

Сотрудники ИТ-отдела компании Contoso осуществляют перенос локальных  серверов Contoso на Windows Server 2019. Как администратор  инфраструктуры Windows Server вы отвечаете за управление сетевой  инфраструктурой для Windows Server и ее обслуживание, что помогает  компании Contoso достичь своих бизнес-целей. В рамках этой роли  необходимо развернуть и обслуживать DHCP-серверы, чтобы автоматизировать выделение конфигураций IP-адресов в организации.

После прохождения этого модуля вы узнаете, как установить и настроить роль DHCP-сервера на компьютерах под управлением Windows Server 2019 и  управлять ею. Вы также узнаете, как развертывать и настраивать параметры высокой доступности DHCP.

## Цели обучения

По завершении этого модуля вы получите следующие навыки:

- Описание роли DHCP-сервера.
- Установка и настройка роли DHCP-сервера.
- Настройка параметров DHCP.
- Создание и настройка области DHCP.
- Описание параметров высокого уровня доступности для DHCP.
- Описание процедуры отработки отказа DHCP и объяснение принципов ее настройки.

## Предварительные требования

Для получения максимальной пользы от данного модуля вы должны иметь знания и опыт в следующих областях:

- Концепции и технологии доменных служб Active Directory.
- Windows Server.
- Базовые сетевые технологии.
- Клиентские операционные системы Windows, такие как Windows 10.







# Использование DHCP для упрощения настройки IP-адресов

DHCP автоматически настраивает сетевые устройства с использованием сведений о настройке IP-адреса. Это поможет ИТ-специалистам в компании  Contoso упростить и централизовать размещение конфигураций IP-адресов.  Если компания Contoso не использует DHCP, при каждом добавлении клиента в сеть потребуется настроить сетевой интерфейс с данными о сети, к  которой выполняется подключение.

 Совет

Сведения, которые необходимо настроить, включают IP-адрес, маску  подсети для сети, параметры DNS клиента для разрешения имен и шлюз по  умолчанию для доступа к другим сетям.

## Преимущества DHCP

Основное преимущество использования DHCP заключается в сокращении  объема обслуживания, необходимого для настройки сведений об IP-адресах  на сетевых устройствах. Многие организации управляют тысячами  компьютерных устройств, включая принтеры, сканеры, смартфоны, настольные компьютеры и ноутбуки. По этой причине управлять вручную конфигурациями IP-адресов сети для организаций такого размера непрактично.

Поскольку DHCP является автоматическим процессом, он более точен, чем настройка сведений об IP-адресах вручную. Это особенно важно для  пользователей, которые не знают и не понимают процесс настройки.

DHCP упрощает обновление сведений о конфигурации IP-адресов. Как  администратор, при изменении сетевой службы (например, при указании  нового DNS-сервера) вы выполняете только одно обновление на  DHCP-серверах, и эти изменения получают все DHCP-клиенты. Например,  мобильный пользователь с переносным компьютером, на котором используется DHCP, автоматически получает новые сведения о конфигурации IP-адресов  при подключении к новой сети.

 Примечание

По умолчанию все операционные системы Windows автоматически получают IP-адреса после первой установки операционной системы (ОС).

## Как работает DHCP

Служба DHCP-клиента выполняется на всех компьютерах Windows, для  которых свойства TCP/IP настроены для автоматического получения  IP-адреса. DHCP-клиент взаимодействует с DHCP-сервером для получения  сведений о конфигурации IP-адресов. Клиенты могут использовать  назначенный DHCP-адрес в течение определенного периода *аренды*.  DHCP-сервер настроен с использованием пула адресов и параметров  конфигурации. Эта информация определяет, какие данные о конфигурации  IP-адреса будут переданы клиентам. На следующем рисунке представлен процесс обмена данными, состоящий из  четырех этапов.

![Схема, на которой показан процесс обмена данными между DHCP-сервером и DHCP-клиентом. Он состоит из DHCPDISCOVER, DHCPOFFER, DHCPREQUEST и DHCPACK.](https://docs.microsoft.com/ru-ru/learn/wwl-windows-server/deploy-manage-dynamic-host-configuration-protocol/media/m11-dynamic-host-configuration-protocol-server-communication.png)

Для обмена данными при создании аренды DHCP используются  IP-трансляции. Поскольку IP-трансляции не маршрутизируются, необходимо  настроить DHCP-сервер в каждой подсети или настроить ретранслятор DHCP.  Многие маршрутизаторы предоставляют функции ретранслятора DHCP.

Четыре этапа создания аренды:

1. DHCP-клиент выполняет широковещательную рассылку пакета  DHCPDISCOVER. Единственными компьютерами, которые отправляют отклик,  являются компьютеры, имеющие роль DHCP-сервера, или компьютеры и  маршрутизаторы, на которых выполняется агент ретранслятора DHCP. В  последнем случае агент ретранслятора DHCP переадресует сообщение на  DHCP-сервер, настроенный для ретрансляции запросов.
2. DHCP-сервер отвечает пакетом DHCPOFFER, который содержит  потенциальный адрес клиента. Если несколько DHCP-серверов получат пакет  DHCPDISCOVER, отклик может прийти от нескольких DHCP-серверов.
3. Клиент получает пакет DHCPOFFER. Если клиент получает несколько  пакетов DHCPOFFER, он выбирает первый отклик. Затем клиент отправляет  пакет DHCPREQUEST, который содержит идентификатор сервера. Таким образом DHCP-серверы, которые принимают широковещательную рассылку, получают  информацию о том, какой сервер DHCPOFFER клиент решил принять.
4. DHCP-серверы получают пакет DHCPREQUEST. Серверы, которые клиент не  принял, используют это сообщение как уведомление о том, что клиент  отклонил предложение этого сервера. Выбранный сервер хранит сведения об  IP-адресе и клиенте в базе данных DHCP и отправляет в ответ сообщение  DHCPACK. Если DHCP-сервер не может предоставить адрес, предложенный в  начальном сообщении DHCPOFFER, DHCP-сервер отправляет сообщение DHCPNAK.

## Продление аренды DHCP

Когда пройдет 50 % времени аренды DHCP, клиент автоматически  попытается продлить аренду. Процесс выполняется в фоновом режиме.  Компьютер может использовать тот же IP-адрес, назначенный DHCP-серверу, в течение продолжительного времени. Это связано с тем, что компьютер  продлевает аренду несколько раз.

Чтобы продлить аренду IP-адреса, клиент отправляет одноадресное  сообщение DHCPREQUEST. Сервер, изначально арендовавший IP-адрес,  отправляет клиенту в ответ сообщение DHCPACK. Это сообщение содержит все новые параметры, измененные с момента создания исходной аренды.  Обратите внимание, что эти пакеты не включаются в широковещательную  рассылку, так как на этом этапе у клиента есть IP-адрес, который можно  использовать для одноадресной рассылки.

 Примечание

При обновлении параметров конфигурации DHCP клиенты могут не получить обновленные параметры до тех пор, пока не истечет 50 % времени аренды.  Например, если настроить срок аренды, равный шести дням, клиенты могут  три дня не получить обновленные параметры.

Если DHCP-клиент не может связаться с DHCP-сервером, клиент ждет,  пока не истечет 87,5 % времени аренды. На этом этапе клиент отправляет  широковещательное сообщение (не одноадресное) DHCPREQUEST, чтобы  получить продление аренды, а запрос передается на все DHCP-серверы, а не только на тот сервер, который предоставил исходную аренду. Однако этот  широковещательный запрос предназначен для продления, а не для получения  новой аренды.

Так как клиентские компьютеры можно перемещать, когда они отключены  (например, портативный компьютер, подключенный к новой подсети),  клиентские компьютеры также пытаются выполнить продление в процессе  запуска или при обнаружении компьютером изменения в сети. Если продление прошло успешно, период аренды сбрасывается.

## DHCP версии 6

DHCP версии 6 (DHCPv6) поддерживает конфигурации с отслеживанием  состояния и без отслеживания состояния для настройки клиентов в среде  IPv6. Конфигурация с отслеживанием состояния используется, когда  DHCPv6-сервер назначает клиенту адрес IPv6, а также дополнительные  данные DHCP. Конфигурация без отслеживания состояния используется, когда маршрутизатор назначает IPv6-адрес автоматически, и сервер DHCPv6  назначает только другие параметры конфигурации IPv6.
